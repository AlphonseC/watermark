# watermark 使用說明

## 批次處理圖片浮水印

### 支持設定水印圖片、透明度、縮放比例及位置（支持左上、上、中下、右下等）。
## 本應用程式主要依賴下列模組：
### Pillow：進行圖片讀寫與處理
### psutil：用於監控記憶體使用量（GC 混合模式下必需）

---

## 一、參數說明

程式支援透過命令列參數或配置文件（config.json）設定參數。以下為各參數的詳細說明及驗證規則：

1. **`--input-folder (-if)`**
    - **說明：** 指定待處理圖片的輸入資料夾。
    - **預設：** `"original"`
2. **`--watermark (-w)`**
    - **說明：** 指定浮水印圖片檔案（必須存在且支援 PNG）。
    - **預設：** `"Logo.png"`
3. **`--opacity (-o)`**
    - **說明：** 設定浮水印透明度，必須介於 0 與 1 之間（包含 0 與 1）。
    - **預設：** `0.65`
4. **`--position (-p)`**
    - **說明：** 指定浮水印位置，僅允許以下值：
        - `"left_top"`
        - `"top"`
        - `"right_top"`
        - `"bottom"`
        - `"right_bottom"`
    - **預設：** `"bottom"`
5. **`--quality (-q)`**
    - **說明：** JPEG 輸出圖片品質，必須介於 1 至 100 之間。
    - **預設：** `100`
6. **`--scale (-s)`**
    - **說明：** 浮水印縮放比例（相對於圖片較短邊的百分比），必須介於 1 至 100 之間。
    - **預設：** `15`
7. **`--margin-vertical (-mv)`**
    - **說明：** 直向圖片中，水印與圖片邊緣間的間距（像素）。
    - **預設：** `20`
8. **`--margin-horizontal (-mh)`**
    - **說明：** 橫向圖片中，水印與圖片邊緣間的間距（像素）。
    - **預設：** `15`
9. **`--output-folder (-of)`**
    - **預設：** `"output"`
10. **`--recursive (-r)`**
    - **說明：** 是否遞迴處理子資料夾中的圖片。
    - **預設：** `false`
11. **`--gc-batch-size`**
    - **說明：** 每處理多少張圖片後進行垃圾回收檢查。
    - **驗證：** 必須為大於 0 的整數。
    - **預設：** `20`
12. **`--gc-memory-threshold`**
    - **說明：** 記憶體使用量門檻（MB），當超過此值時觸發垃圾回收。
    - **驗證：** 必須為大於 0 的整數。
    - **預設：** `500`
13. **`--memory-check-interval`**
    - **說明：** 記憶體監控線程的檢查間隔（秒）。
    - **驗證：** 必須為大於 0 的整數。
    - **預設：** `5`
14. **`--enable-mixed-mode`**
    - **說明：** 是否啟用混合模式（先檢查記憶體使用量，再依據圖片數量作備用檢查）。
    - **預設：** `false`
15. **`--enable-parallel`**
    - **說明：** 是否啟用平行處理功能；啟用時會在輸出檔案名稱中加入 UUID 以避免檔名衝突。
    - **預設：** `false`
16. **`--uuid-length`**
    - **說明：** 平行處理時輸出檔名中 UUID 的長度，必須介於 4 到 36 之間。
    - **驗證：** 使用 `uuid_length_type` 函式。
    - **預設：** `6`
17. **`--config (-c)`**
    - **說明：** 指定 JSON 格式的配置文件，若存在則自動讀取。
    - **預設：** 無

* * *

## 二、配置文件 (config.json) 範例

以下是一個完整的配置文件範例，供使用者修改與使用：

```
{
  "input_folder": "original",
  "watermark": "Logo.png",
  "opacity": 0.65,
  "position": "bottom",
  "quality": 100,
  "scale": 15,
  "margin_vertical": 20,
  "margin_horizontal": 15,
  "output_folder": "output",
  "recursive": false,
  "gc_batch_size": 20,
  "gc_memory_threshold": 500,
  "memory_check_interval": 5,
  "enable_mixed_mode": false,
  "enable_parallel": false,
  "uuid_length": 6
}
```

**注意：**

- 當配置文件與命令列參數同時設定時，命令列參數具有較高優先權。
- 輸入資料夾不存在時，程式會自動建立。若水印檔案不存在，則程式會立即終止並提示錯誤。

* * *

## 三、運行方式

### 1\. 基本運行

將程式碼存為 `watermark_app.py`，並將待處理圖片放在 `original` 資料夾中，直接執行：

```
python watermark_app.py
```

此時，程式會依據預設參數或配置文件進行順序處理，並根據圖片數量執行垃圾回收檢查。

### 2\. 使用配置文件

若已有配置文件（例如 config.json），可使用：

```
python watermark_app.py --config config.json
```

程式會讀取配置文件中的參數，並使用命令列參數覆蓋配置文件中的設定。

### 3\. 啟用平行處理與自訂 UUID 長度

例如，若希望啟用平行處理且輸出檔名中 UUID 長度為 6：

```
python watermark_app.py --enable-parallel --uuid-length 6
```

在平行處理模式下，程式會利用多線程同時處理圖片，並在每個輸出檔名中加入 6 碼 UUID，以避免檔名重複。同時，獨立的記憶體監控線程會根據設定檢查記憶體使用量。

### 4\. 啟用混合模式

若希望在平行處理模式下，先依據記憶體使用量檢查，再依據圖片數量作備用檢查，可加上 `--enable-mixed-mode`：

```
python watermark_app.py --enable-parallel --enable-mixed-mode --uuid-length 6
```

* * *

## 四、記憶體管理與平行處理模式說明

- **順序處理模式：**  
程式依據圖片數量（預設每 20 張）執行垃圾回收檢查，直接使用原始輸出檔名，不加入 UUID。
- **平行處理模式：**  
啟用平行處理後，程式利用多線程同時處理圖片，並啟動記憶體監控線程，定期檢查記憶體使用量（預設每 5 秒檢查，門檻為 500 MB）。在此模式下，輸出檔名會加入由 `--uuid-length` 指定長度的 UUID，以避免檔名重複。如果啟用混合模式（--enable-mixed-mode），則程式會先檢查記憶體使用量，若超過門檻則立即觸發垃圾回收；否則依據圖片數量進行檢查。

* * *

## 五、常見問題

1. **參數錯誤時會如何處理？**  
使用自訂型別函式進行驗證，若有任何參數不符合規定（例如水印檔案不存在、透明度超出範圍等），argparse 會在解析階段拋出錯誤並終止程式，避免進入批量處理階段。
2. **如何避免檔名衝突？**  
在平行處理模式下，程式會在輸出檔名中加入由 UUID 產生的唯一識別碼，其長度可透過 `--uuid-length` 自訂；順序處理模式下則直接使用原始輸出檔名。
3. **記憶體管理如何運作？**  
程式會啟動獨立的記憶體監控線程，依據 `--memory-check-interval` 與 `--gc-memory-threshold` 設定檢查記憶體使用量，若超過門檻則觸發垃圾回收 gc.collect()；同時在順序處理模式下，每處理一定數量的圖片（`--gc-batch-size`）後也會檢查並觸發垃圾回收。
