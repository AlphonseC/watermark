# watermark 使用說明

## 批次處理圖片浮水印

### 支持設定水印圖片、透明度、縮放比例及位置（支持左上、上、中下、右下等）。
## 本應用程式主要依賴下列模組：
### Pillow：進行圖片讀寫與處理
### psutil：用於監控記憶體使用量（GC 混合模式下必需）

---

## 一、參數說明

本應用程式支援透過命令列參數或 JSON 配置文件設定各項參數。以下列出所有參數及其用途：

1. **`--config (-c)`**  
**說明：** 指定配置文件（JSON 格式）。若工作目錄中存在該文件，程式將讀取並更新參數；命令列參數會覆蓋配置文件中的值。  
**預設值：** 無
2. **`--input-folder (-if)`**  
**說明：** 指定待處理圖片的輸入資料夾。  
**預設值：** `"original"`
3. **`--watermark (-w)`**  
**說明：** 指定浮水印圖片檔案（建議使用 PNG 格式）。  
**預設值：** `"Logo.png"`
4. **`--opacity (-o)`**  
**說明：** 設定浮水印透明度，數值介於 0（全透明）與 1（完全不透明）之間。  
**預設值：** `0.65`
5. **`--position (-p)`**  
**說明：** 指定浮水印在圖片中的位置。可選項目：
    - `"left_top"`：左上角
    - `"top"`：上方（水平置中）
    - `"right_top"`：右上角
    - `"left_bottom"`：左下角
    - `"bottom"`：下方（水平置中）
    - `"right_bottom"`：右下角**預設值：** `"bottom"`
6. **`--quality (-q)`**  
**說明：** 設定輸出圖片（JPEG 格式）的壓縮品質。數值 100 表示無壓縮。  
**預設值：** `100`
7. **`--scale (-s)`**  
**說明：** 指定浮水印縮放比例（以圖片較短邊的百分比計算），決定浮水印在圖片中的相對大小。  
**預設值：** `15`
8. **`--margin-vertical (-mv)`**  
**說明：** 設定直向（portrait）圖片中，浮水印與圖片邊緣間的間距（像素）。  
**預設值：** `20`
9. **`--margin-horizontal (-mh)`**  
**說明：** 設定橫向（landscape）圖片中，浮水印與圖片邊緣間的間距（像素）。  
**預設值：** `15`
10. **`--output-folder (-of)`**  
**說明：** 指定處理後圖片的輸出資料夾。若啟用遞迴處理，程式會在此資料夾中建立與輸入資料夾相同的目錄結構。  
**預設值：** `"output"`
11. **`--recursive (-r)`**  
**說明：** 控制是否遞迴處理輸入資料夾中的子資料夾。  
**預設值：** `false`
12. **`--gc-batch-size`**  
**說明：** 每處理指定數量的圖片後觸發一次垃圾回收檢查（僅依據圖片張數）。  
**預設值：** `20`
13. **`--gc-memory-threshold`**  
**說明：** 記憶體使用量門檻（單位 MB），當使用量超過此值時觸發垃圾回收。  
**預設值：** `500` MB
14. **`--enable-mixed-mode`**  
**說明：** 是否啟用混合模式垃圾回收檢查。
    - 若啟用（值為 true），程式會先檢查記憶體使用量，若超過 gc\_memory\_threshold 則立即觸發 gc；若記憶體使用量低於門檻，則以圖片張數為備用檢查依據。
    - 若未啟用，僅依據圖片張數進行垃圾回收檢查。**預設值：** `false`

* * *

## 二、配置文件 (config.json)

若您希望集中管理參數設定，可在工作目錄中建立一個 JSON 格式的配置文件（預設檔名：config.json）。  
下列為一個範例（此範例中 gc 管理僅依據圖片張數，若需要混合模式請將 enable\_mixed\_mode 設為 true）：

```
{
  "input_folder": "original",
  "watermark": "Logo.png",
  "opacity": 0.65,
  "position": "bottom",
  "quality": 100,
  "scale": 15,
  "margin_vertical": 20,
  "margin_horizontal": 15,
  "output_folder": "output",
  "recursive": false,
  "gc_batch_size": 20,
  "gc_memory_threshold": 500,
  "enable_mixed_mode": false
}
```

**注意：**

- 當同時使用命令列參數與配置文件時，命令列參數具有較高優先權。
- 若欲啟用混合模式 GC 檢查，請將 `"enable_mixed_mode": true` 設定在配置文件中，或在命令列中加上 `--enable-mixed-mode` 參數。

* * *

## 三、如何運行程式

### 4.1 基本運行

將程式碼存為 `watermark_app.py`，並確保所有待處理圖片放置於 `original` 資料夾中。若使用預設參數，直接在命令列中執行：

```
python watermark_app.py
```

### 4.2 指定配置文件運行

假設配置文件名稱為 config.json，請使用：

```
python watermark_app.py --config config.json
```

### 4.3 自訂參數運行

您可以直接在命令列中指定參數。例如：

```
python watermark_app.py -w MyLogo.png -o 0.8 -p right_bottom -s 20 -of my_output -r
```

上例中：

- 使用浮水印圖片 `MyLogo.png`
- 設定透明度 0.8
- 設定水印位置在右下角
- 設定縮放比例為 20
- 輸出資料夾為 `my_output`
- 啟用遞迴處理子資料夾

### 4.4 混合模式 GC 運行

若您希望啟用混合模式垃圾回收（先依據記憶體使用量，再依據圖片張數進行檢查），可在命令列中加入 `--enable-mixed-mode` 或在配置文件中將 `"enable_mixed_mode": true` 設定。

例如：

```
python watermark_app.py --enable-mixed-mode
```

此時程式將依下列邏輯進行 GC 檢查：

1. 每處理完一張圖片後，若記憶體使用量超過 500 MB（或使用者自訂的門檻值），則立即觸發垃圾回收。
2. 若記憶體使用量未超過門檻，則每處理 20 張圖片（或使用者自訂的 gc\_batch\_size）後進行一次垃圾回收檢查。

* * *

## 四、垃圾回收（GC）管理說明

本程式內建兩種垃圾回收檢查模式：

- **僅依據圖片張數檢查（預設模式）：**每處理 20 張圖片後（可透過 `--gc-batch-size` 調整）觸發一次 gc.collect()，用以釋放不再使用的資源。
- **混合模式（可選）：**若啟用混合模式（`--enable-mixed-mode` 為 true），程式將先檢查目前記憶體使用量。若記憶體使用量超過設定的門檻（預設 500 MB，可透過 `--gc-memory-threshold` 調整），則立即觸發垃圾回收；否則則依據圖片張數進行備用檢查。這種方式可更精確地控制記憶體使用，防止系統資源過度累積。

* * *

## 五、常見問題

### Q1：若不使用配置文件，預設參數會如何生效？

- **A1：** 若未提供配置文件，程式將採用 argparse 中的預設值。預設下輸入資料夾為 `original`、輸出資料夾為 `output`，垃圾回收僅依據圖片張數，每 20 張觸發一次，且混合模式預設關閉。

### Q2：為何需要建立虛擬環境？

- **A2：** 虛擬環境可以讓您在隔離的環境中安裝必要的套件，避免與其他專案或系統套件發生衝突。

### Q3：圖片格式有哪些限制？

- **A3：** 程式支援 PNG、JPG、JPEG、BMP、GIF 格式。請注意，浮水印圖片建議使用 PNG 格式以保留透明度。

### Q4：如何啟用子資料夾處理？

- **A4：** 在命令列中加入 `--recursive` 或 `-r`，或在配置文件中將 `"recursive": true`。

* * *

##
